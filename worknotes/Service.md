# 应用服务

---
### 置顶  

1 用户访问数据限制
2 机组运行统计
3


---

### 1 用户访问数据限制
```
1 多用户，多部门，允许用户查看不同部门数据，但不允许不同部门之间的用户修改对方的数据。

2 根据部门划分数据区：
  录入业务数据时，携带部门标识。
  页面展示时，显示部门名称。
  
3 思路：
  1 部门树形层级的结构，业务数据产生于某一层部门，部门管理db表，添加字段-dataMask
  
  2 用户登录成功，根据用户所属部门，识别dataMask字段，指定用户访问的数据区。生成session时，添加字段belongToDeptId, belongToDeptName

```

---

### 2 机组运行统计
```
1 机组状态，事件和转移：
  1 状态：静止，发电，检修
  1 事件：停机，开机，检修开始，检修结束
  
  2 转移：
   
     静止        -开机->   发电  
                <-停机-   
      |   ^ 
      检  |
      修 检
      开 修
      始 结  
      |  束
      V   |
      
       检修

2 DB表：
  1 机组事件表
    序号
    站点编号
    机组编号
    事件：停机，开机，检修开始，检修结束
    时间戳
    运行时间
      停机时间 - 相邻开机时间	（跨年）
    检修时间（计划 停机）
      检修结束时间 - 相邻检修开始时间 （跨年）

    创建者：本人可修改，删除
    创建时间戳
    更新时间戳
  
  2 机组统计表，年度周期
    序号
    站点编号
    机组编号
    年份
    状态：静止，发电，检修
    开机时间戳
    检修开始时间戳
    开机次数
      正常开机事件计数
    检修次数
      检修开始事件计数
    运行累计时间
      正常、故障停机事件，运行时间求和
    检修累计时间
      检修结束事件，检修时间求和
    创建时间戳
    更新时间戳  
    

3 录入时，检查事件日期，确保正确性，避免 修改，删除操作。
  允许修改，删除机组事件表记录。
  补录
  选取时间段，导出事件记录

4 处理流程：
  1 新增事件：
    开机：
      取last记录（停机事件），last记录与提交日期年份比较：
        相等：增加事件表记录，更新统计表状态=发电，开机时间戳，开机次数
        不等：增加事件表记录，统计表新增X+1年（初值0），状态=发电，开机时间戳，开机次数=1
    
    停机：
      取last记录（开机事件），last记录与提交日期年份比较：
        相等：计算运行时间，增加事件表记录，更新统计表状态=静止，运行累计时间
        不等：更新统计表X年，运行累计时间（12-31 23:59:59），统计表新增X+1年（初值0），状态=静止，运行累计时间（1-1 0:0:0）
          
    检修开始：
      取last记录（停机事件），last记录与提交日期年份比较：
        相等：增加时间表记录，更新统计表状态=检修，检修开始时间戳，检修次数
        不等：增加事件表记录，统计表新增X+1年（初值0），状态=检修，检修开始时间戳，检修次数=1
    
    检修结束：
      取last记录（检修开始事件），last记录与提交日期年份比较：
        相等：计算检修时间，增加事件表记录，更新统计表状态=静止，检修累计时间
        不等：更新统计表X年，检修累计时间（12-31 23:59:59），统计表新增X+1年（初值0），状态=静止，检修累计时间（1-1 0:0:0）
        
  2 查询统计：
    查询年份与当前日期比较：
      相等：
        若查询数据表：
          为空：取X年记录，新增X+1年（初值0），状态=X年状态。状态=静止，结束处理；发电，前端显示运行时间 now-（1-1 0:0:0）；检修，前端显示检修时间 now-（1-1 0:0:0）
          非空：取X年记录，状态=静止，结束处理；发电，前端显示运行时间 运行累计时间 + now-开机时间戳；检修，前端显示检修时间 检修累计时间 + now-检修开始时间戳.
          
      不等：
        取出查询年份记录
        
  3 修改事件记录
    只允许修改事件的时间戳，不允许修改事件类型。
  
  4 删除事件记录
    只允许从最近记录开始，逐条删除
    
    n=开机：
        取n和n-1条记录，比较年份：
          相等：删除事件记录，n的年份，修改统计表状态=静止，开机时间戳=0，开机次数-1
          不等：删除事件记录，n的年份，修改统计表状态=静止，开机时间戳=0，开机次数=0
    
    n=停机：
        取n和n-1条记录，比较年份：
          相等：删除事件记录，n的年份，修改统计表状态=发电，运行累计时间-
          不等：删除事件记录，n的年份，修改统计表状态=发电，开机时间戳=0，运行累计时间=0

5 初始化
  手动往DB表中添加一条停机事件，类似状态机的起始状态

```

### 2 机组开停机统计
```
1 事件：
  停机，开机

2 方案：
  1 DB保存事件，由后端完成统计，使用sql的统计功能。
  
  2 统计开机运行时间，录入停机事件时，计算时长，并存入事件。
    当开机运行跨年，X+1年录入停机事件时，以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。
  
  3 修改、删除
    1 只允许修改事件时间，不允许修改事件类型；只允许修改、删除最后一条记录，不允许修改或删除中间记录。
      1 修改最后一条记录：
        停机：修改时间不能早于前一条记录，T开，T停，T停新综合判断，重新计算运行时间，跨年特别处理。
        开机：修改时间不能早于前一条记录。
        
      2 删除最后一条记录：
        停机：T开，T停判断，重新计算运行时间，跨年处理。
        开机：无特别处理。

3 DB表：
  1 机组事件表
    序号
    站点编号
    机组编号
    事件：停机，开机
    时间
    运行时间
    创建者
    创建时间
    更新时间
 

4 录入时，检查事件日期，确保正确性，避免 修改，删除操作。
  补录
  选取时间段，导出事件记录

5 处理流程：
  1 新增事件：
    开机：
      检查事件日期，确保正确性
    
    停机：
      检查事件日期，确保正确性
      取上一条，与提交日期年份比较：
        相等：计算运行时间，增加事件表记录
        不等：以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。

  2 查询统计：
    查询年份与当前日期比较：
      相等：
        若查询数据表：
          为空：取X年记录，新增X+1年（初值0），状态=X年状态。状态=静止，结束处理；发电，前端显示运行时间 now-（1-1 0:0:0）；检修，前端显示检修时间 now-（1-1 0:0:0）
          非空：取X年记录，状态=静止，结束处理；发电，前端显示运行时间 运行累计时间 + now-开机时间戳；检修，前端显示检修时间 检修累计时间 + now-检修开始时间戳.
          
      不等：
        取出查询年份记录


    


5 初始化
  手动往DB表中添加一条停机事件，类似状态机的起始状态

```

---
### 2 
```

```



---
### 
```

```

---
### 
```

```