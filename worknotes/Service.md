# 应用服务

---
### 置顶  

1 用户访问数据限制
2 机组开停机统计
3 电量统计


---

### 1 用户访问数据限制
```
1 多用户，多部门，允许用户查看不同部门数据，但不允许不同部门之间的用户修改对方的数据。

2 根据部门划分数据区：
  录入业务数据时，携带部门标识。
  页面展示时，显示部门名称。
  
3 思路：
  1 部门树形层级的结构，业务数据产生于某一层部门，部门管理db表，添加字段-dataMask
  
  2 用户登录成功，根据用户所属部门，识别dataMask字段，指定用户访问的数据区。生成session时，添加字段belongToDeptId, belongToDeptName

```

---

### 2 机组开停机统计
```
1 事件：
  停机，开机

2 方案：
  1 DB保存事件，由后端完成统计，使用sql的统计功能。
  
  2 统计开机运行时间，录入停机事件时，计算时长，并存入事件。
    当开机运行跨年，X+1年录入停机事件时，以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。
  
  3 修改、删除
    1 只允许修改事件时间，不允许修改事件类型；只允许修改、删除最后一条记录，不允许修改或删除中间记录。
      1 修改最后一条记录：
        停机：修改时间不能早于前一条记录，T开，T停，T停新综合判断，重新计算运行时间，跨年特别处理。
        开机：修改时间不能早于前一条记录。
        
      2 删除最后一条记录：
        停机：T开，T停判断，重新计算运行时间，跨年处理。
        开机：无特别处理。
  
  4 导出excel
  
3 DB表：
  1 机组事件表
    序号
    站点编号
    机组编号
    事件：停机，开机
    时间
    运行时间
    创建者
    创建时间
    更新时间
 

4 录入时，检查事件日期，确保正确性，避免 修改，删除操作。
  补录
  选取时间段，导出事件记录

5 录入：
  1 新增事件：
    开机：
      检查事件日期，确保正确性
    
    停机：
      检查事件日期，确保正确性
      取上一条，与提交日期年份比较：
        相等：计算运行时间，增加事件表记录
        不等：以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。

  2 查询统计：
    按年份，站点 统计开机次数和运行总时长。


```

---
### 3 电量统计 
```
1 分解
  1 记录年度计划电量，分摊至12个月
  2 记录电量：
    1 线路电表：正反向有功，无功电量
    2 机组电表：正向有功，正反向无功电量
    3 厂用变电表：正向有功电量
    4 隔离变电表：正向有功电量
    5 机组峰谷电量
    6 弃水电量
  3 记录时间：
    20:00
    24:00
    
  4 统计：
    1 上网电量：
      1 全厂日
      2 全厂月
      3 全厂季度
      4 全厂年度
    2 下网电量：
    
    3 弃水电量
      1 全厂日
      2 全厂月
      3 全厂年度发电量

2 页面功能区：
  1 每日电表录入区
  2 日，月，季度，年度电量统计显示区
  3 年度计划录入区
  4 年度计划显示区
  
3 方案：
  1 记录：
    1 每天20点，24点记录各个电表读数，一天只允许有两个时间点的记录。
      1 记录X条：X-1，X；检查值不能小于前值，考虑电表计数翻转
    2 允许补记录：
      1 缺少一天
      2 缺少多天
  
  3 修改、删除
    1 允许修改任意日期的电表读数记录，同步修改日电量：
      1 修改X条：X-1，X；检查值不能小于前值，考虑电表计数翻转
      2 修改X条：X-1，X，X+1；检查值不能小于前值，不能大于后值，考虑电表计数翻转
      
    2 只允许从最末尾的记录开始删除  

4 DB表：
  1 电表
    序号
    站点编号
    日期时间  - YYYY-MM-DD HH:MM
    电表编号
    正向有功读数
    正向无功读数
    反向有功读数
    反向无功读数
    峰值
    谷值
    
    日正向有功电量
    日正向无功电量
    日反向有功电量
    日反向无功电量
    峰电量
    谷电量
    编辑人
    创建时间
    更新时间

```



---
### 
```

```

---
### 
```

```