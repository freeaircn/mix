# 应用服务

---
### 置顶  

1 用户访问数据限制
2 机组开停机统计
3 电量统计


---

### 1 用户访问数据限制
```
1 多用户，多部门，允许用户查看不同部门数据，但不允许不同部门之间的用户修改对方的数据。

2 根据部门划分数据区：
  录入业务数据时，携带部门标识。
  页面展示时，显示部门名称。
  
3 思路：
  1 部门树形层级的结构，业务数据产生于某一层部门，部门管理db表，添加字段-dataMask
  
  2 用户登录成功，根据用户所属部门，识别dataMask字段，指定用户访问的数据区。生成session时，添加字段belongToDeptId, belongToDeptName

```

---

### 2 机组开停机统计
```
1 事件：
  停机，开机

2 方案：
  1 DB保存事件，由后端完成统计，使用sql的统计功能。
  
  2 统计开机运行时间，录入停机事件时，计算时长，并存入事件。
    当开机运行跨年，X+1年录入停机事件时，以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。
  
  3 修改、删除
    1 只允许修改事件时间，不允许修改事件类型；只允许修改、删除最后一条记录，不允许修改或删除中间记录。
      1 修改最后一条记录：
        停机：修改时间不能早于前一条记录，T开，T停，T停新综合判断，重新计算运行时间，跨年特别处理。
        开机：修改时间不能早于前一条记录。
        
      2 删除最后一条记录：
        停机：T开，T停判断，重新计算运行时间，跨年处理。
        开机：无特别处理。
  
  4 导出excel
  
3 DB表：
  1 机组事件表
    序号
    站点编号
    机组编号
    事件：停机，开机
    时间
    运行时间
    创建者
    创建时间
    更新时间
 

4 录入时，检查事件日期，确保正确性，避免 修改，删除操作。
  补录
  选取时间段，导出事件记录

5 录入：
  1 新增事件：
    开机：
      检查事件日期，确保正确性
    
    停机：
      检查事件日期，确保正确性
      取上一条，与提交日期年份比较：
        相等：计算运行时间，增加事件表记录
        不等：以01-01 00:00:00为分界，计算时长存入上一条开机事件和当前停机事件。

  2 查询统计：
    按年份，站点 统计开机次数和运行总时长。


```

---
### 3 电量统计 
```
1 分解
  1 记录年度计划电量，分摊至12个月
  2 记录电量：
    1 线路电表：正反向有功，无功电量
    2 机组电表：正向有功，正反向无功电量
    3 厂用变电表：正向有功电量
    4 隔离变电表：正向有功电量
    5 机组峰谷电量
    6 弃水电量
  3 记录时间：
    20:00
    24:00
    
  4 统计：
    1 上网电量：
      1 全厂日
      2 全厂月
      3 全厂季度
      4 全厂年度
    2 下网电量：
    
    3 弃水电量
      1 全厂日
      2 全厂月
      3 全厂年度发电量

2 页面功能区：
  1 每日电表录入区
  2 日，月，季度，年度电量统计显示区
  3 年度计划录入区
  4 年度计划显示区
  
3 方案：
  1 记录：
    1 每天20点，24点记录各个电表读数，一天只允许有两个时间点的记录。
      1 记录X条：X-1，X；检查值不能小于前值，考虑电表计数翻转
    2 只允许连续日期的记录，不允许：X天不存在，录入X+1天
    3 ？补记录：
      1 缺少一天
      2 缺少多天
  
  3 修改、删除
    1 不允许修改，只允许从最末尾的记录开始删除  

4 DB表：
  1 电表
    序号
    站点编号
    日期时间  - YYYY-MM-DD H:m:s
    电表编号
    正向有功读数
    正向无功读数
    反向有功读数
    反向无功读数
    峰值
    谷值
    
    编辑人
    创建时间
    更新时间
    
  2 年度计划
    序号
    站点编号
    年份  - YYYY-MM-DD
    1月计划
    2月计划
    ...
    
    编辑人
    创建时间
    更新时间
    
5 数据单位和范围
  1 电表
    1 线路表：kwh，4位小数，变比1320000
    2 机组表：kwh，2位小数，变比500000
    3 其他表：kwh，2位小数，变比20000
    电表数的范围：8位数，mysql unsigned int 最大值10位数，足够存储电表数。
  
  2 计划发电量和成交电量
    万kwh，4位小数
    以苏家河的装机容量，最大年发电量：315000 kwh * 24 * 365 = 2 759 400 000 kwh
    mysql unsigned int 最大值4 294 967 295，足够存储年发电量。
    
  3 数据类型
    1 数据库使用 unsigned int类型存储电表数（不计算变比），默认单位kwh，所有数据位整型，不用浮点型。
    2 输入的电表数，含小数，扩大至整数（与变比不同），线路表*10000，机组表*100，再写入数据库
    3 输入的计划发电量和成交电量，4位小数，将万kwh转kwh（与变比不同），乘以10000，再写入数据库
    4 页面显示时，计算变比：13200，5000，200；单位转换：kwh与万kwh互转。
    
6 简报数据
  1 每日
    松山河口电厂
    2021年08月26日，发电量为69.5万千瓦时。
    截止08月26日24时，电厂本月完成发电量4631万千瓦时，完成月度发电计划的42.10%，
    三季度累计完成发电量13392万千瓦时，完成季度发电计划的46.18%，
    本年累计完成发电量为36836.5万千瓦时,完成年度发电计划的50.81%。
    本日弃水电量为0万kWh，本月弃水电量累计0万kWh。
    
    每日发电量
    月累计发电量，月计划完成率
    季度累计发电量，季度计划完成率
    年累计发电量，月计划完成率
  
  2 每周
    松山河口电厂本周(2021年08月20日00点至2021年08月27日00点)
    发电量为1276万千瓦时，
    上网电量为1269.9852万千瓦时；

    截至08月27日00点，
    8月累计发电量为4631万千瓦时，完成月度发电计划的42.10%，
    本年度发电量为36836.5万千瓦时，完成年度发电计划的50.81%。
    
    周累计发电量
    周上网电量
    月累计发电量，月计划完成率
    年累计发电量，月计划完成率
    
  3 每日2
    松山河口电厂：
    2021年8月29日发电机组为#1、#2、#3机组，出力在0MW到161MW之间，
    机组日实际发电量为46.5万kWh，
    日上网电量为46.4904万kWh。
    截止8月29日24时，
    电厂本月完成上网电量4815.9276万kWh，完成月度成交电量的48.16%，本年完成上网电量36842.2824万kWh。
    本日弃水电量为0万kWh，本月弃水电量累计0万kWh。
  
    日发电量
    日上网电量
    月累计上网电量，月成交率完成率
    年累计上网电量
    
  4 计算：
    日发电量
    月累计发电量，月计划完成率
    季度累计发电量，季度计划完成率
    年累计发电量，年计划完成率
    
    周累计发电量
    周累计上网电量
    
    日上网电量
    月累计上网电量，月成交率完成率
    年累计上网电量
    
    ##
    1 机组出口电表
      日峰谷电量
      日，周，月，季度，年 累计发电量
      月计划完成率
      季度计划完成率
      年计划完成率
    
    2 线路主表
      日，周，月，年 累计上网电量 
      月成交率完成率
    
    3 计划值，月成交值
    
    测试数据：
    // 年
    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`) VALUES 
    ('2', '2020-12-31', '23:59:00', '1', '36735860'),
    ('2', '2020-12-31', '23:59:00', '3', '344869'),
    ('2', '2020-12-31', '23:59:00', '4', '389232'),
    ('2', '2020-12-31', '23:59:00', '5', '242709');

    // 季度 
    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`) VALUES
    ('2', '2021-06-30', '23:59:00', '1', '38501720'),
    ('2', '2021-06-30', '23:59:00', '3', '353263'),
    ('2', '2021-06-30', '23:59:00', '4', '406752'),
    ('2', '2021-06-30', '23:59:00', '5', '263682');

    // 月 
    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`) VALUES
    ('2', '2021-07-31', '23:59:00', '1', '39162030'),
    ('2', '2021-07-31', '23:59:00', '3', '358722'),
    ('2', '2021-07-31', '23:59:00', '4', '412698'),
    ('2', '2021-07-31', '23:59:00', '5', '269798');

    // 周 
    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`) VALUES
    ('2', '2021-08-19', '23:59:00', '1', '39414990'),
    ('2', '2021-08-19', '23:59:00', '3', '360717'),
    ('2', '2021-08-19', '23:59:00', '4', '414987'),
    ('2', '2021-08-19', '23:59:00', '5', '272229');


    // 日 
    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`) VALUES
    ('2', '2021-08-25', '23:59:00', '1', '39506110'),
    ('2', '2021-08-25', '23:59:00', '3', '361439'),
    ('2', '2021-08-25', '23:59:00', '4', '415825'),
    ('2', '2021-08-25', '23:59:00', '5', '273086');


    INSERT INTO `app_meter` (`station_id`, `log_date`, `log_time`, `meter_id`, `fak`, `fak_delta`) VALUES
    ('2', '2021-08-26', '23:59:00', '1', '39511170', '5060'),
    ('2', '2021-08-26', '23:59:00', '3', '361474', '35'),
    ('2', '2021-08-26', '23:59:00', '4', '415855', '30'),
    ('2', '2021-08-26', '23:59:00', '5', '273155', '69');


    INSERT INTO `app_kwh_planning` (`station_id`, `year`, `month`, `planning`, `deal`) VALUES 
    ('2', '2021', '1', '42000000', '40100000'),
    ('2', '2021', '2', '37000000', '0'),
    ('2', '2021', '3', '43000000', '0'),
    ('2', '2021', '4', '51000000', '0'),
    ('2', '2021', '5', '37000000', '0'),
    ('2', '2021', '6', '43000000', '0'),
    ('2', '2021', '7', '90000000', '0'),
    ('2', '2021', '8', '110000000', '99989687'),
    ('2', '2021', '9', '90000000', '0'),
    ('2', '2021', '10', '85000000', '0'),
    ('2', '2021', '11', '57000000', '0'),
    ('2', '2021', '12', '40000000', '0');

  
    
  
  
    
```



---
### 
```

```

---
### 
```

```